name: Release Battle Scrolls

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: true
        type: string
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set version variables
        run: |
          # Get version from tag or manual input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            # Extract version from tag (v1.0.0 -> 1.0.0)
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi

          # AddOnVersion: incrementing integer (avoids semver comparison issues)
          ADDON_VERSION=${{ github.run_number }}

          # Release notes file for this version
          RELEASE_NOTES="release-notes/v${VERSION}.txt"

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "ADDON_VERSION=$ADDON_VERSION" >> $GITHUB_ENV
          echo "ZIP_FULL_NAME=BattleScrolls-${VERSION}.zip" >> $GITHUB_ENV
          echo "RELEASE_NOTES=$RELEASE_NOTES" >> $GITHUB_ENV

      - name: Show computed values
        run: |
          echo "VERSION=$VERSION"
          echo "ADDON_VERSION=$ADDON_VERSION"
          echo "ZIP_FULL_NAME=$ZIP_FULL_NAME"
          echo "RELEASE_NOTES=$RELEASE_NOTES"

      - name: Verify release notes exist
        run: |
          if [ ! -f "${{ env.RELEASE_NOTES }}" ]; then
            echo "::error::Release notes not found: ${{ env.RELEASE_NOTES }}"
            echo "Create the file before tagging a release."
            exit 1
          fi
          echo "Release notes found:"
          cat "${{ env.RELEASE_NOTES }}"

      - name: Replace version placeholders in manifest
        run: |
          # Replace {{addon_version}} with integer for ESO's version comparison
          sed -i "s/{{addon_version}}/${{ env.ADDON_VERSION }}/g" BattleScrolls/BattleScrolls.addon
          # Replace {{version}} with semver for human-readable display
          sed -i "s/{{version}}/${{ env.VERSION }}/g" BattleScrolls/BattleScrolls.addon

          echo "Manifest after replacement:"
          head -15 BattleScrolls/BattleScrolls.addon

      - name: Include LICENSE in addon folder
        run: |
          cp LICENSE BattleScrolls/

      - name: Create ZIP archive
        run: |
          rm -f "${{ env.ZIP_FULL_NAME }}" || true
          zip -r --quiet "${{ env.ZIP_FULL_NAME }}" BattleScrolls
          ls -lh "${{ env.ZIP_FULL_NAME }}"

      - name: Upload to Bethesda.net
        uses: m00nyONE/bnet-upload@a5bc28415932bf614f092bd04515ed333da1359f
        with:
          BNET_USERNAME: ${{ secrets.BNET_USERNAME }}
          BNET_PASSWORD: ${{ secrets.BNET_PASSWORD }}
          addon_id: 'ec9ce729-a472-4150-8f3c-1df05a369ad0'
          version: ${{ env.VERSION }}
          zip_file: ${{ env.ZIP_FULL_NAME }}
          release_notes_file: ${{ env.RELEASE_NOTES }}
          cli_uploader_version: '1.3.0'

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ZIP_FULL_NAME }}
          body_path: ${{ env.RELEASE_NOTES }}
          draft: false
          prerelease: false
